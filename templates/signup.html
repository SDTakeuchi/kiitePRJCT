{% extends 'base/base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block content %}
<div class="main users-new">
    <div class="container">
      <div class="form-heading">Sign up</div>
      <div class="form users-form">
        <div class="form-body">
          <p>
            <span style="margin-right: 4px; padding-top: 4px; color:#931919;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
              </svg>
            </span>
            学習院大学の在学生および卒業生でない方の利用はご遠慮ください。
          </p>
  
          <form method="POST" action="">
            {% csrf_token %}
            <hr>
              <p>ご本人様のお名前</p>
              {{ form.real_name | add_class:"form-control" | attr:"autofocus" }}
              <hr>
              
              <p>メールアドレス</p>
              {{ form.email | add_class:"form-control" }}
              <p>　※各種キャリアメールアドレスやicloud.comのドメインは使用不可な場合があります。gmailなどフリーメールアドレスのご利用を推奨します。</p>
              <hr>
              
              <p>ユーザーネーム</p>
              {{ form.name | add_class:"form-control" }}
              <hr>

              <p>パスワード</p>
              {{ form.password1 | add_class:"form-control" }}
              <hr>

              <p>パスワード（確認用）</p>
              {{ form.password2 | add_class:"form-control" }}
              <hr>

              <p>入学年度（西暦）</p>
              {{ form.entry_year | add_class:"form-control" }}
              <hr>

              <p>在籍状況</p>
              {{ form.student_status | add_class:"form-control" }}
              <hr>

              <div id="signup_alumni_form" class="hide">  
                <div class="job_form">
                  <p>業界</p>
                  <p class="fs-13" style="margin:0;">大分類</p>
                  {{ form.job_parent_category | add_class:"form-control parent-form" }}
                  <br>
                  <p class="fs-13" style="margin:0;">小分類</p>
                  {{ form.job_category | add_class:"form-control" | attr:"disabled" }}
                  <hr>
                </div>

                <p>職種</p>
                {{ form.job_type | add_class:"form-control" }}
                <hr>
  
                <p>内定を獲得していた業界</p>
                {{ formset.management_form }}
                {% for line_form in formset %}
                  <div class="job_form">
                    {% for hidden in line_form.hidden_fields %} <!-- necessary for some reason... -->
                      {{ hidden }}
                    {% endfor %}
                    <button type="button" class="btn btn-danger job-form-reset-btn hide">リセット</button>
                    <p>{{ forloop.counter }}</p>
                    <p class="fs-13" style="margin:0;">大分類</p>
                    {{ line_form.offered_job_parent_category | add_class:"form-control parent-form" }}
                    <br>
                    <p class="fs-13" style="margin:0;">小分類</p>
                    {{ line_form.offered_job_child_category | add_class:"form-control child-form" | attr:"disabled" }}
                    <div class="emptybox"></div>
                    {{ line_form.DELETE | add_class:"hide" }}
                  </div>
                {% endfor %}
                <hr>
              </div>

              {{ form.errors }}
              <p>※ 卒業生として登録される際には、運営によって身元の確認が行われます。その間はサービスをご利用できませんのでご了承ください。</p>
              <p>※ 登録することで、<a href="{% url 'terms_of_use' %}" target="_blank" rel="noopener noreferrer">利用規約</a>と<a href="{% url 'privacy_policy' %}" target="_blank" rel="noopener noreferrer">プライバシーポリシー</a>に同意したものとみなされます。</p>

            <input type="submit"  id="submit" name="Create User" value="登録">
          </form>
          <p>すでにアカウントをお持ちの方は<a href="{% url 'login'%}">コチラ</a></p>
        </div>
      </div>
    </div>
  </div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script>
  // 業界選択時の処理
  const categories = {
    {% for parent in parent_category_list %}
      '{{ parent.pk }}' : [
        {% for category in parent.alumnijobchildcategory_set.all %}
          {
            'pk': '{{ category.pk }}',
            'name': '{{ category.name }}'
          },
        {% endfor %}
      ],
    {% endfor %}
  };

  $('.job_form select.parent-form').on('change', function () {
    const childJobCategoryElem = $(this).siblings('select');
    const parentJobCategoryElem = $(this);

    childJobCategoryElem.children().remove();
    childJobCategoryElem.removeAttr('disabled');
    $(this).siblings('.job-form-reset-btn').removeClass('hide');

    const parentId = parentJobCategoryElem.val();
    const categoryList = categories[parentId];

    // 子カテゴリの選択肢を作成、追加。
    childJobCategoryElem.append($('<option value="">---------</option>'));
    for (const category of categoryList) {
      const option = $('<option>');
      option.val(category['pk']);
      option.text(category['name']);
      childJobCategoryElem.append(option);
    }
  });

  // reset job select form
  $(document).on('click', '.job-form-reset-btn', function() {
    $(this).siblings('input[type="checkbox"]').prop('checked', true);
    $(this).siblings('select.parent-form').find('option:eq(0)').prop('selected', true);
    $(this).siblings('select.child-form').prop('disabled', true);
    $(this).siblings('select.child-form').children('option:not(option:eq(0))').remove();
    $(this).addClass('hide');
  });

  $(document).on('change', 'select.child-form', function() {
    $(this).siblings('input[type="checkbox"]').prop('checked', false);
  });

  $('#id_student_status').on('change', function () {
    if ($(this).val() == '卒業生') {
      $('#signup_alumni_form').removeClass('hide');
    } else {
      if (!$('#signup_alumni_form').hasClass('hide')) {
        $('#signup_alumni_form').addClass('hide');
      }
    }
  });


  // form validation
  $('input[type="submit"]').on('click', function () {
    for (i=0; i<3; i++) {
      const thisRowChildForm = $('select.child-form:eq(' + i + ')');
      if(typeof thisRowChildForm.attr('disabled') === 'undefined' || thisRowChildForm.attr('disabled') === false) {
        if(thisRowChildForm.val() == '') {
          alert('内定を獲得していた業界の' + (i+1) + '列目の子分類が未選択です。');
          return false;
        }
      }
    }
    if (typeof $('#id_job_category').attr('disabled') === 'undefined' || $('#id_job_category').attr('disabled') === false) {
      if ($('#id_job_category').val() == '') {
        alert('現在の業界の子分類が未選択です。');
        return false;
      }
    }
  });

</script>
{% endblock %}